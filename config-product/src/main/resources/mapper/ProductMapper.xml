<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.getidea.config.product.mapper.ProductMapper">

    <resultMap id="BaseResultMapper" type="top.getidea.config.common.entity.product.Product">
        <id javaType="java.lang.Integer" property="productId" jdbcType="INTEGER" column="product_id"/>
        <result javaType="java.lang.String" property="productName" jdbcType="VARCHAR" column="product_name"/>
        <result javaType="java.lang.Integer" property="managerId" jdbcType="INTEGER" column="manager"/>
        <result javaType="java.lang.Integer" property="testerId" jdbcType="INTEGER" column="tester"/>
        <result javaType="java.lang.String" property="prodVersion" jdbcType="VARCHAR" column="prod_version"/>
        <result javaType="java.lang.String" property="codeVersion" jdbcType="VARCHAR" column="code_version"/>
        <result javaType="java.lang.String" property="message" jdbcType="VARCHAR" column="message"/>
        <result javaType="java.lang.String" property="codeAddress" jdbcType="VARCHAR" column="code_address"/>
        <result javaType="java.util.Date" property="createTime" jdbcType="TIMESTAMP" column="create_time"/>
        <result javaType="java.util.Date" property="modifyTime" jdbcType="TIMESTAMP" column="modify_time"/>
    </resultMap>

    <insert id="addProduct" keyProperty="productId" useGeneratedKeys="true">
        INSERT INTO
        config_product(
        <if test="status != null and status != ''">
            status,
        </if>
        <if test="productName != null and productName != ''">
            product_name,
        </if>
        <if test="manager != null and manager != ''">
            manager,
        </if>
        <if test="tester != null and tester != ''">
            tester,
        </if>
        <if test="codeVersion != null and codeVersion != ''">
            code_version,
        </if>
        <if test="prodVersion != null and prodVersion != ''">
            prod_version,
        </if>
        <if test="codeAddress != null and codeAddress != ''">
            code_address,
        </if>
        <if test="message != null and message != ''">
            message,
        </if>
        <if test="attached != null and attached != ''">
            attached,
        </if>
        <if test="createTime != null and createTime != ''">
            create_time,
        </if>
        <if test="modifyTime != null and modifyTime != ''">
            modify_time,
        </if>
        )
        VALUES
        (
        <if test="status != null and status != ''">
            #{status},
        </if>
        <if test="productName != null and productName != ''">
            #{product_name},
        </if>
        <if test="manager != null and manager != ''">
            #{manager},
        </if>
        <if test="tester != null and tester != ''">
            #{tester},
        </if>
        <if test="codeVersion != null and codeVersion != ''">
            #{code_version},
        </if>
        <if test="prodVersion != null and prodVersion != ''">
            #{prod_version},
        </if>
        <if test="codeAddress != null and codeAddress != ''">
            #{code_address},
        </if>
        <if test="message != null and message != ''">
            #{message},
        </if>
        <if test="attached != null and attached != ''">
            #{attached},
        </if>
        <if test="createTime != null and createTime != ''">
            #{create_time},
        </if>
        <if test="modifyTime != null and modifyTime != ''">
            #{modify_time},
        </if>
        );
    </insert>

    <update id="deleteProduct">
        UPDATE act_config_product
        SET is_delete = 'true'
        WHERE product_id IN (SELECT product_id
                             FROM act_config_product
                             WHERE product_name IN (SELECT product_name
                                                    FROM act_config_product
                                                    WHERE product_id = #{ ID }
                             )
        )
    </update>

    <update id="deleteSinProduct">
        UPDATE act_config_product
        SET is_delete = 'true'
        WHERE product_id = #{ ID }
    </update>

    <update id="updateProduct">
        UPDATE act_config_product
        SET product_name         = #{productName},
            product_manager      = #{productManager},
            tester               = #{tester},
            product_version      = #{productVersion},
            code_version         = #{codeVersion},
            code_version_message = #{codeVersionMessage},
            address              = #{address},
            doc_id               = #{docId},
            note                 = #{note},
            modify_time          = now()
        WHERE product_id = #{productId}
    </update>

    <update id="publishProduct">
        UPDATE act_config_product
        SET status = '2'
        WHERE product_id = #{id}
    </update>
    <update id="deleteProductByKeys">
        UPDATE config_product
        SET is_delete = false
        WHERE product_id IN
        <foreach collection="ids" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </update>

    <select id="getList" resultMap="BaseResultMapper">
        SELECT product_id, product_name, manager, message, modify_time
        FROM config_product product
        WHERE product.prod_version = (
        SELECT max(prod_version) FROM config_product WHERE product.product_name = config_product.product_name
        )
        <if test="key != null and key != ''">
            AND product_name LIKE concat ( '%', #{key}, '%' )
        </if>
        AND is_delete = false
        LIMIT #{offset}, #{rows}
    </select>

    <select id="getListOfStatus" resultMap="BaseResultMapper">
        SELECT act_config_product.*,
               u1.s_realname AS manager_name,
               u2.s_realname AS tester_name
        FROM act_config_product
                 LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                 LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
        WHERE is_delete = FALSE
          AND product_id IN (SELECT MAX(product_id) FROM act_config_product GROUP BY product_name)
          AND status = #{status}
        ORDER BY status DESC,
                 product_id DESC
    </select>

    <select id="getProductById" resultMap="BaseResultMapper">
        SELECT *
        FROM act_config_product
        WHERE product_id = #{id}
          AND is_delete = FALSE
    </select>

    <select id="getProductByName" resultMap="BaseResultMapper">
        SELECT act_config_product.*,
               u1.s_realname AS manager_name,
               u2.s_realname AS tester_name
        FROM act_config_product
                 LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                 LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
        WHERE product_name = (SELECT product_name FROM act_config_product WHERE product_id = #{id})
          AND is_delete = FALSE
        ORDER BY product_id DESC
    </select>


    <select id="searchProduct" resultMap="BaseResultMapper">
        (SELECT act_config_product.*,
                u1.s_realname AS manager_name,
                u2.s_realname AS tester_name
         FROM act_config_product
                  LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                  LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
         WHERE product_name LIKE concat('%', #{name}, '%')
           AND is_delete = FALSE
           AND product_id IN (SELECT MAX(product_id) FROM act_config_product GROUP BY product_name)
        )
        UNION
        (
            SELECT act_config_product.*,
                   u1.s_realname AS manager_name,
                   u2.s_realname AS tester_name
            FROM act_config_product
                     LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                     LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
            WHERE product_manager IN (SELECT s_id FROM sys_user WHERE s_realname LIKE concat('%', #{name}, '%'))
              AND is_delete = FALSE
              AND product_id IN (SELECT MAX(product_id) FROM act_config_product GROUP BY product_name)
        )
        ORDER BY product_id DESC
    </select>

    <select id="searchProductByStatus" resultMap="BaseResultMapper">
        (SELECT act_config_product.*,
                u1.s_realname AS manager_name,
                u2.s_realname AS tester_name
         FROM act_config_product
                  LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                  LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
         WHERE product_name LIKE concat('%', #{name}, '%')
           AND is_delete = FALSE
           AND product_id IN (SELECT MAX(product_id) FROM act_config_product GROUP BY product_name)
           AND status = #{status}
        )
        UNION
        (
            SELECT act_config_product.*,
                   u1.s_realname AS manager_name,
                   u2.s_realname AS tester_name
            FROM act_config_product
                     LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
                     LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
            WHERE product_manager IN (SELECT s_id FROM sys_user WHERE s_realname LIKE concat('%', #{name}, '%'))
              AND is_delete = FALSE
              AND product_id IN (SELECT MAX(product_id) FROM act_config_product GROUP BY product_name)
              AND status = #{status}
        )
        ORDER BY product_id DESC
    </select>

    <select id="getProductByProjectId" resultMap="BaseResultMapper">
        SELECT *
        FROM act_config_product
        WHERE act_config_product.product_id IN (SELECT product_id
                                                FROM act_config_product_project
                                                WHERE act_config_product_project.project_id = #{projectId}
        )
    </select>
    <select id="searchProds" resultMap="BaseResultMapper">
        SELECT product_id, product_name, manager, tester, prod_version, code_version, code_address, message, create_time, modify_time
        FROM config_product product
        WHERE product.prod_version = (
        SELECT max(prod_version) FROM config_product WHERE product.product_name = config_product.product_name
        )
        <if test="key != null and key != ''">
            AND product_name LIKE concat ( '%', #{key}, '%' )
        </if>
        AND is_delete = false
        LIMIT #{offset}, #{rows}
    </select>
    <select id="searchCountOfProds" resultType="java.lang.Integer">
        SELECT
        count(0)
        FROM
        act_config_product
        LEFT JOIN sys_user u1 ON act_config_product.product_manager = u1.s_id
        LEFT JOIN sys_user u2 ON act_config_product.tester = u2.s_id
        WHERE
        <trim prefixOverrides="and">
            <if test="key != null and key != ''">
                AND ( product_name LIKE concat ( '%', #{key}, '%' ) OR product_manager IN ( SELECT s_id FROM sys_user WHERE s_realname LIKE concat ( '%', #{key}, '%' ) ) )
            </if>
            <if test="status != null and status.length == 1">
                AND status = #{status[0]}
            </if>
            <if test="status != null and status.length > 1">
                AND status IN
                <foreach collection="status" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            AND is_delete = FALSE
            AND product_id IN ( SELECT MAX ( product_id ) FROM act_config_product GROUP BY product_name )
        </trim>
    </select>

    <sql id="Base-ref">
        product_id productId,
    product_name productName,
    product_manager productManager,
    tester tester,
    product_version productVersion,
    code_version codeVersion,
    code_version_message codeVersionMessage,
    address address,
    doc_id docId,
    note note,
    create_time createTime,
    modify_time modifyTime,
    is_delete isDelete,
    status status
    </sql>
</mapper>